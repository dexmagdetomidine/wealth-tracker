<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthEngine Pro | Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .tab-active { border-bottom: 2px solid #6366f1; color: #4338ca; font-weight: 800; }
        input, select { border: 1px solid #cbd5e1; transition: all 0.2s; outline: none; }
        input:focus, select:focus { border-color: #6366f1; ring: 2px; ring-color: #e0e7ff; }
        .price-input { width: 90px; text-align: right; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px 8px; font-weight: 700; }
        .progress-bg { height: 10px; background-color: #f1f5f9; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { display: none !important; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
        .overflow-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Auth & AppID Config Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="toggleSettings()"></div>
        <div class="card relative w-full max-w-lg p-8 shadow-2xl">
            <h3 class="text-sm font-black uppercase tracking-widest text-indigo-600 mb-2">Cloud Configuration</h3>
            <p class="text-[11px] text-slate-500 mb-4 font-medium">Ensure your App ID matches your Firestore Security Rules exactly.</p>
            
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase">Firebase Config (JSON)</label>
                    <textarea id="fb-config-input" rows="5" placeholder='{"apiKey": "...", ...}' class="w-full p-3 bg-slate-50 border rounded-xl text-[11px] font-mono"></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase">App ID (Required for Permissions)</label>
                    <input type="text" id="fb-appid-input" placeholder="wealth-engine-pro-v3" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold text-indigo-600">
                </div>
                
                <div id="google-auth-section" class="pt-4 border-t hidden">
                    <div id="auth-error-msg" class="hidden mb-3 p-2 bg-rose-50 text-rose-600 text-[10px] font-bold rounded border border-rose-100"></div>
                    <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 py-3 rounded-xl font-black text-xs hover:bg-slate-50 shadow-sm transition-all">
                        Sign in with Google
                    </button>
                    <button id="signout-btn" class="hidden w-full mt-2 text-[10px] text-slate-400 font-bold uppercase hover:text-rose-500">Sign Out</button>
                </div>

                <div class="flex gap-2 pt-2">
                    <button onclick="saveSettings()" class="flex-1 bg-indigo-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg">Save & Connect</button>
                    <button onclick="toggleSettings()" class="px-6 bg-slate-100 text-slate-500 font-black py-3 rounded-xl uppercase text-xs">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-black tracking-tighter text-slate-800">WealthEngine</h1>
            <div class="flex items-center gap-3">
                <div id="auth-status" onclick="toggleSettings()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 border rounded-xl text-[10px] font-black uppercase cursor-pointer">
                    <span id="sync-dot" class="w-2 h-2 rounded-full bg-slate-400"></span>
                    <span id="sync-text">Checking...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div id="auth-gate-msg" class="card p-12 text-center">
            <h2 class="text-lg font-black text-slate-800 mb-2">Access Locked</h2>
            <p class="text-sm text-slate-500 mb-6">Please configure your Firebase credentials and Sign In to view your portfolio.</p>
            <button onclick="toggleSettings()" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-black text-xs uppercase shadow-lg">Setup Connection</button>
        </div>

        <div id="main-content" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="card p-6"><p class="text-[10px] font-black text-slate-400 uppercase mb-1">Portfolio Value</p><h2 id="total-val" class="text-2xl font-black">HK$0.00</h2></div>
                <div class="card p-6 border-l-4 border-l-emerald-500"><p class="text-[10px] font-black text-slate-400 uppercase mb-1">Total Return</p><h2 id="total-return" class="text-2xl font-black text-emerald-600">HK$0.00</h2></div>
                <div class="card p-6"><p class="text-[10px] font-black text-slate-400 uppercase mb-1">Income</p><h2 id="total-income" class="text-2xl font-black text-blue-600">HK$0.00</h2></div>
                <div class="card p-6"><p class="text-[10px] font-black text-slate-400 uppercase mb-1">Fees</p><h2 id="total-fees" class="text-2xl font-black text-rose-500">HK$0.00</h2></div>
            </div>
            
            <div class="card p-6 mb-8">
                <h3 class="text-xs font-black uppercase text-slate-400 mb-4">Quick Trade</h3>
                <form id="tx-form" class="grid grid-cols-2 md:grid-cols-6 gap-4">
                    <input type="date" id="t-date" class="p-2 text-xs font-bold bg-slate-50 border rounded-lg">
                    <input type="text" id="t-symbol" placeholder="SYMBOL" class="p-2 text-xs font-bold bg-slate-50 border rounded-lg uppercase">
                    <select id="t-action" class="p-2 text-xs font-bold bg-slate-50 border rounded-lg"><option value="BUY">BUY</option><option value="SELL">SELL</option></select>
                    <input type="number" id="t-qty" placeholder="Units" class="p-2 text-xs font-bold bg-slate-50 border rounded-lg">
                    <input type="number" id="t-price" step="any" placeholder="Price" class="p-2 text-xs font-bold bg-slate-50 border rounded-lg">
                    <button type="submit" class="bg-indigo-600 text-white font-black rounded-lg text-[10px] uppercase">Add</button>
                </form>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInWithRedirect, getRedirectResult, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let db, auth;
        const DEFAULT_APP_ID = "wealth-engine-pro-v3";
        const appId = localStorage.getItem('we_fb_appid') || DEFAULT_APP_ID;

        window.toggleSettings = () => document.getElementById('settings-modal').classList.toggle('hidden');

        window.saveSettings = () => {
            const config = document.getElementById('fb-config-input').value.trim();
            const newAppId = document.getElementById('fb-appid-input').value.trim() || DEFAULT_APP_ID;
            if(!config) return;
            localStorage.setItem('we_fb_config', config);
            localStorage.setItem('we_fb_appid', newAppId);
            window.location.reload();
        };

        const showError = (msg) => {
            const errDiv = document.getElementById('auth-error-msg');
            errDiv.innerText = msg;
            errDiv.classList.remove('hidden');
        };

        async function init() {
            const configStr = localStorage.getItem('we_fb_config');
            if (!configStr) return;

            try {
                const config = JSON.parse(configStr);
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);

                document.getElementById('google-auth-section').classList.remove('hidden');
                
                // Sign in logic
                document.getElementById('google-signin-btn').onclick = async () => {
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                    } catch (e) {
                        console.error("Popup failed, trying redirect:", e);
                        await signInWithRedirect(auth, provider);
                    }
                };

                document.getElementById('signout-btn').onclick = () => signOut(auth);

                onAuthStateChanged(auth, u => {
                    const dot = document.getElementById('sync-dot');
                    const text = document.getElementById('sync-text');
                    const gate = document.getElementById('auth-gate-msg');
                    const main = document.getElementById('main-content');
                    const signout = document.getElementById('signout-btn');

                    if (u) {
                        dot.className = "w-2 h-2 rounded-full bg-emerald-500";
                        text.innerText = u.displayName || "Connected";
                        gate.classList.add('hidden');
                        main.classList.remove('hidden');
                        signout.classList.toggle('hidden', u.isAnonymous);
                        
                        onSnapshot(collection(db, 'artifacts', appId, 'users', u.uid, 'transactions'), () => {
                            console.log("Data sync verified.");
                        }, (err) => {
                            if(err.code === 'permission-denied') {
                                text.innerText = "Permission Denied";
                                dot.className = "w-2 h-2 rounded-full bg-rose-500";
                            }
                        });
                    } else {
                        dot.className = "w-2 h-2 rounded-full bg-amber-400";
                        text.innerText = "Signed Out";
                        gate.classList.remove('hidden');
                        main.classList.add('hidden');
                    }
                });

                // Check for redirect result
                getRedirectResult(auth).catch(e => showError(e.message));

            } catch (e) {
                console.error("Initialization failed", e);
            }
        }

        init();
    </script>
</body>
</html>