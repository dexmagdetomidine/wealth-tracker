<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthEngine Pro | Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #0f172a; }
        .card { background: white; border: 1px solid #e2e8f0; border-radius: 1rem; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        .tab-active { border-bottom: 2px solid #6366f1; color: #4338ca; font-weight: 800; }
        .currency-pill { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; }
        input, select { border: 1px solid #cbd5e1; transition: all 0.2s; outline: none; }
        input:focus, select:focus { border-color: #6366f1; ring: 2px; ring-color: #e0e7ff; }
        .price-input { width: 90px; text-align: right; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 4px 8px; font-weight: 700; }
        .progress-bg { height: 10px; background-color: #f1f5f9; border-radius: 6px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .hidden { display: none !important; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(4px); }
        .live-tag { animation: pulse-light 2s infinite; }
        @keyframes pulse-light { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        /* Prevent truncation */
        .overflow-container { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { min-width: 950px; }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- Config/Auth Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4">
        <div class="modal-overlay absolute inset-0" onclick="toggleSettings()"></div>
        <div class="card relative w-full max-w-lg p-8 shadow-2xl">
            <h3 class="text-sm font-black uppercase tracking-widest text-indigo-600 mb-2">Cloud Setup</h3>
            <p class="text-[11px] text-slate-500 mb-4 font-medium">To sync across devices, paste your Firebase Config JSON here.</p>
            
            <div id="auth-warning" class="hidden mb-4 p-3 bg-rose-50 border border-rose-100 text-rose-600 text-xs font-bold rounded-lg"></div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase">Firebase Config (JSON)</label>
                    <textarea id="fb-config-input" rows="6" placeholder='{"apiKey": "...", ...}' class="w-full p-3 bg-slate-50 border rounded-xl text-[11px] font-mono"></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase">App ID (Optional)</label>
                    <input type="text" id="fb-appid-input" placeholder="wealth-engine-pro-v3" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold">
                </div>
                
                <div id="google-auth-section" class="pt-4 border-t hidden">
                    <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 bg-white border border-slate-200 py-3 rounded-xl font-black text-xs hover:bg-slate-50 shadow-sm transition-all">
                        <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                        Sign in with Google
                    </button>
                </div>

                <div class="flex gap-2 pt-2">
                    <button onclick="saveSettings()" class="flex-1 bg-indigo-600 text-white font-black py-3 rounded-xl uppercase text-xs shadow-lg">Save Config</button>
                    <button onclick="toggleSettings()" class="px-6 bg-slate-100 text-slate-500 font-black py-3 rounded-xl uppercase text-xs">Close</button>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-white border-b sticky top-0 z-50 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-black tracking-tighter flex items-center gap-2 text-slate-800">
                <span class="bg-indigo-600 text-white px-2 py-0.5 rounded-lg">WE</span> WealthEngine
            </h1>
            
            <div class="flex items-center gap-3">
                <!-- 11. FX Rate Hybrid -->
                <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-indigo-50 border border-indigo-100 rounded-xl">
                    <span class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">USD/HKD</span>
                    <div class="flex items-center gap-1">
                        <input type="number" id="fx-rate-input" step="0.0001" class="w-16 bg-transparent border-none p-0 text-xs font-black text-indigo-700 focus:ring-0 text-right" value="7.8210">
                        <span id="fx-live-indicator" class="text-[8px] font-black bg-indigo-200 text-indigo-700 px-1.5 py-0.5 rounded live-tag hidden">LIVE</span>
                    </div>
                </div>

                <!-- 10. Google Sign In Trigger -->
                <div id="auth-status" onclick="toggleSettings()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 border rounded-xl text-[10px] font-black uppercase cursor-pointer hover:bg-slate-200 transition-all">
                    <span id="sync-dot" class="w-2 h-2 rounded-full bg-slate-400"></span>
                    <span id="sync-text">Setup</span>
                </div>
                
                <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-indigo-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- 2. Four Total Overviews -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="card p-6">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Portfolio Value</p>
                <h2 id="total-val-hkd" class="text-xl md:text-2xl font-black text-slate-900">HK$0.00</h2>
                <p id="unrealized-gain" class="text-[10px] font-bold text-slate-400 mt-1">Unrealized: $0.00</p>
            </div>
            <div class="card p-6 border-l-4 border-l-emerald-500">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Net Wealth Change</p>
                <h2 id="grand-total-profit" class="text-xl md:text-2xl font-black text-emerald-600">HK$0.00</h2>
            </div>
            <div class="card p-6">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Passive Income</p>
                <h2 id="total-div-hkd" class="text-xl md:text-2xl font-black text-blue-600">HK$0.00</h2>
            </div>
            <div class="card p-6">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Fees</p>
                <h2 id="total-fees-display" class="text-xl md:text-2xl font-black text-rose-500">HK$0.00</h2>
            </div>
        </div>

        <!-- 1. Market Exposure & Asset Allocation -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card p-6">
                <h3 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-5">Market Exposure</h3>
                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-[10px] font-black mb-1.5 uppercase text-slate-500"><span>HKD Assets</span><span id="exp-hk-pct">0%</span></div>
                        <div class="progress-bg"><div id="exp-hk-bar" class="progress-fill bg-indigo-500" style="width: 0%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-[10px] font-black mb-1.5 uppercase text-slate-500"><span>USD Assets</span><span id="exp-us-pct">0%</span></div>
                        <div class="progress-bg"><div id="exp-us-bar" class="progress-fill bg-blue-400" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-xs font-black uppercase tracking-widest text-slate-400 mb-5">Asset Allocation</h3>
                <div class="space-y-5">
                    <div>
                        <div class="flex justify-between text-[10px] font-black mb-1.5 uppercase text-slate-500"><span>Equity / ETF</span><span id="exp-stock-pct">0%</span></div>
                        <div class="progress-bg"><div id="exp-stock-bar" class="progress-fill bg-indigo-600" style="width: 0%"></div></div>
                    </div>
                    <div>
                        <div class="flex justify-between text-[10px] font-black mb-1.5 uppercase text-slate-500"><span>Bonds / Fixed Income</span><span id="exp-bond-pct">0%</span></div>
                        <div class="progress-bg"><div id="exp-bond-bar" class="progress-fill bg-amber-500" style="width: 0%"></div></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forms Section -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-8">
            
            <!-- 3. Trade Execution Form -->
            <div class="lg:col-span-6 card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black uppercase tracking-widest text-slate-400">Trade Execution</h3>
                    <button type="button" id="tx-cancel-btn" class="hidden text-[10px] font-bold text-rose-500 uppercase">Cancel Edit</button>
                </div>
                <form id="tx-form" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <input type="hidden" id="edit-id">
                    <div class="col-span-2 space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Date</label><input type="date" id="trade-date" class="w-full p-2.5 bg-slate-50 border rounded-xl text-xs font-bold" required></div>
                    <div class="col-span-2 space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Asset Class</label><select id="assetType" class="w-full p-2.5 bg-slate-50 border rounded-xl text-xs font-bold"><option value="STOCK">Equity / ETF</option><option value="BOND">Bond / FI</option></select></div>
                    <div class="col-span-2 space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Ticker / Symbol</label><input type="text" id="symbol" placeholder="0700.HK / AAPL" class="w-full p-2.5 bg-slate-50 border rounded-xl text-xs font-bold uppercase" required></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Action</label><select id="action" class="w-full p-2.5 bg-slate-50 border rounded-xl text-xs font-bold"><option value="BUY">BUY</option><option value="SELL">SELL</option></select></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Currency</label><select id="currency" class="w-full p-2.5 bg-slate-50 border rounded-xl text-xs font-bold"><option value="HKD">HKD</option><option value="USD">USD</option></select></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Qty</label><input type="number" id="shares" step="any" class="w-full p-2.5 bg-slate-50 border rounded-xl text-xs font-bold" required></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Price</label><input type="number" id="price" step="any" class="w-full p-2.5 bg-slate-50 border rounded-xl text-xs font-bold" required></div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Fee</label><input type="number" id="fee" step="any" value="0" class="w-full p-2.5 bg-slate-50 border rounded-xl text-xs font-bold"></div>
                    <button type="submit" id="save-tx-btn" class="col-span-2 md:col-span-1 mt-5 bg-indigo-600 text-white font-black py-2.5 rounded-xl uppercase text-[10px] hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-100 disabled:opacity-50 disabled:cursor-not-allowed">Sign In First</button>
                </form>
            </div>
            
            <!-- 4. Income Log -->
            <div class="lg:col-span-3 card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black uppercase tracking-widest text-blue-600">Income Log</h3>
                    <button type="button" id="div-cancel-btn" class="hidden text-[10px] font-bold text-rose-500 uppercase">Cancel</button>
                </div>
                <form id="div-form" class="space-y-3">
                    <input type="hidden" id="div-edit-id">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Type</label><select id="div-type" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold"><option value="DIVIDEND">Dividend</option><option value="COUPON">Coupon</option></select></div>
                        <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Ccy</label><select id="div-currency" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold"><option value="HKD">HKD</option><option value="USD">USD</option></select></div>
                    </div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Asset Symbol</label><input type="text" id="div-symbol" placeholder="Symbol" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold uppercase" required></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Amount</label><input type="number" id="div-amount" step="any" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold" required></div>
                        <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Date</label><input type="date" id="div-date" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold" required></div>
                    </div>
                    <button type="submit" id="log-income-btn" class="w-full bg-blue-600 text-white font-black py-2.5 rounded-xl uppercase text-[10px] disabled:opacity-50 disabled:cursor-not-allowed">Sign In First</button>
                </form>
            </div>

            <!-- 5. Fees Section -->
            <div class="lg:col-span-3 card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black uppercase tracking-widest text-rose-500">Other Fees</h3>
                    <button type="button" id="fee-cancel-btn" class="hidden text-[10px] font-bold text-rose-500 uppercase">Cancel</button>
                </div>
                <form id="fee-form" class="space-y-3">
                    <input type="hidden" id="fee-edit-id">
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Description</label><input type="text" id="fee-desc" placeholder="e.g. Custody Fee" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold" required></div>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Amount</label><input type="number" id="fee-amount" step="any" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold" required></div>
                        <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Ccy</label><select id="fee-currency" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold"><option value="HKD">HKD</option><option value="USD">USD</option></select></div>
                    </div>
                    <div class="space-y-1"><label class="text-[10px] font-black text-slate-400 uppercase">Date</label><input type="date" id="fee-date" class="w-full p-2 bg-slate-50 border rounded-lg text-xs font-bold" required></div>
                    <button type="submit" id="log-fees-btn" class="w-full bg-rose-500 text-white font-black py-2.5 rounded-xl uppercase text-[10px] disabled:opacity-50 disabled:cursor-not-allowed">Sign In First</button>
                </form>
            </div>
        </div>

        <!-- 6 & 7. Tables -->
        <div class="flex gap-6 border-b border-slate-200 mb-4 px-2">
            <button onclick="setView('portfolio')" id="tab-portfolio" class="pb-3 text-[11px] font-black uppercase tracking-widest tab-active">Current Holdings</button>
            <button onclick="setView('history')" id="tab-history" class="pb-3 text-[11px] font-black uppercase tracking-widest text-slate-400">Transaction Ledger</button>
        </div>

        <div class="card overflow-hidden">
            <div id="portfolio-view" class="overflow-container">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] uppercase text-slate-500 font-black">
                        <tr>
                            <th class="px-6 py-4">Security</th>
                            <th class="px-6 py-4 text-right">Units</th>
                            <th class="px-6 py-4 text-right">Avg Cost</th>
                            <th class="px-6 py-4 text-right">Mkt Price (Input)</th>
                            <th class="px-6 py-4 text-right">Mkt Value</th>
                            <th class="px-6 py-4 text-right">P/L (%)</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-body" class="divide-y divide-slate-100 font-medium text-sm"></tbody>
                </table>
            </div>
            <div id="history-view" class="hidden overflow-container">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 text-[10px] uppercase text-slate-500 font-black">
                        <tr>
                            <th class="px-6 py-4">Date</th>
                            <th class="px-6 py-4">Activity</th>
                            <th class="px-6 py-4">Security / Detail</th>
                            <th class="px-6 py-4 text-right">Amount</th>
                            <th class="px-6 py-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="history-body" class="divide-y divide-slate-100 text-xs font-medium"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let transactions = [], dividends = [], adminFees = [], marketPrices = {};
        let usdToHkd = 7.8210; 
        let db, auth, user;
        const appId = "wealth-engine-pro-v4";

        const fmt = (val, ccy = 'HKD') => {
            const sym = ccy === 'USD' ? '$' : 'HK$';
            return sym + (val || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };

        // --- HANDSHAKE & AUTH GUARD ---
        function setButtonState(online) {
            const btns = ['save-tx-btn', 'log-income-btn', 'log-fees-btn'];
            const labels = ['Save Trade', 'Log Income', 'Log Fee'];
            btns.forEach((id, idx) => {
                const btn = document.getElementById(id);
                btn.disabled = !online;
                btn.innerText = online ? labels[idx] : "⚠️ Sign In First";
                if(online) btn.classList.remove('opacity-50', 'cursor-not-allowed');
                else btn.classList.add('opacity-50', 'cursor-not-allowed');
            });
        }

        window.toggleSettings = () => {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            document.getElementById('fb-config-input').value = localStorage.getItem('we_fb_config') || '';
            document.getElementById('fb-appid-input').value = localStorage.getItem('we_fb_appid') || appId;
        };

        window.saveSettings = () => {
            const config = document.getElementById('fb-config-input').value.trim();
            if (!config) return alert("Please enter JSON");
            try {
                JSON.parse(config);
                localStorage.setItem('we_fb_config', config);
                window.location.reload();
            } catch (e) { alert("Invalid JSON"); }
        };

        window.setView = (v) => {
            document.getElementById('portfolio-view').classList.toggle('hidden', v !== 'portfolio');
            document.getElementById('history-view').classList.toggle('hidden', v !== 'history');
            document.getElementById('tab-portfolio').classList.toggle('tab-active', v === 'portfolio');
            document.getElementById('tab-history').classList.toggle('tab-active', v === 'history');
        };

        function render() {
            const holdings = {};
            let tradingFeesHKD = 0, incomeTotalHKD = 0, totalRealizedHKD = 0;
            let totalAdminFeesHKD = adminFees.reduce((acc, f) => acc + (f.currency === 'USD' ? f.amount * usdToHkd : f.amount), 0);

            transactions.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                const feeHKD = (t.currency === 'USD' ? t.fee * usdToHkd : t.fee);
                tradingFeesHKD += feeHKD;

                if (!holdings[t.symbol]) holdings[t.symbol] = { symbol: t.symbol, type: t.assetType, currency: t.currency, shares: 0, costHKD: 0 };
                
                const factor = (t.assetType === 'BOND') ? 0.01 : 1.0;
                const txCcyFactor = t.currency === 'USD' ? usdToHkd : 1.0;

                if (t.action === 'BUY') {
                    holdings[t.symbol].shares += t.shares;
                    holdings[t.symbol].costHKD += (t.shares * t.price * factor * txCcyFactor) + feeHKD;
                } else {
                    const avgHKD = holdings[t.symbol].costHKD / (holdings[t.symbol].shares || 1);
                    const txValHKD = (t.shares * t.price * factor * txCcyFactor);
                    const txCostBasisHKD = (t.shares * avgHKD);
                    totalRealizedHKD += (txValHKD - feeHKD - txCostBasisHKD);
                    holdings[t.symbol].shares -= t.shares;
                    holdings[t.symbol].costHKD -= txCostBasisHKD;
                }
            });

            dividends.forEach(d => incomeTotalHKD += (d.currency === 'USD' ? d.amount * usdToHkd : d.amount));

            // Portfolio Table
            const pBody = document.getElementById('portfolio-body');
            let totalMktHKD = 0, totalCostHKD = 0, hkVal = 0, usVal = 0, stkVal = 0, bndVal = 0;
            pBody.innerHTML = '';

            Object.values(holdings).filter(h => Math.abs(h.shares) > 0.0001).forEach(h => {
                const factor = (h.type === 'BOND' ? 0.01 : 1);
                const avgPriceLocal = (h.costHKD / h.shares / factor) / (h.currency === 'USD' ? usdToHkd : 1);
                const currentPriceLocal = marketPrices[h.symbol] !== undefined ? marketPrices[h.symbol] : avgPriceLocal;
                const marketValHKD = h.currency === 'USD' ? (h.shares * currentPriceLocal * factor * usdToHkd) : (h.shares * currentPriceLocal * factor);
                
                totalMktHKD += marketValHKD; totalCostHKD += h.costHKD;
                if (h.currency === 'HKD') hkVal += marketValHKD; else usVal += marketValHKD;
                if (h.type === 'STOCK') stkVal += marketValHKD; else bndVal += marketValHKD;

                pBody.innerHTML += `<tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 flex items-center gap-3">
                        <span class="currency-pill ${h.currency==='USD'?'bg-blue-100 text-blue-700':'bg-rose-100 text-rose-700'}">${h.currency}</span>
                        <span class="font-black">${h.symbol}</span>
                    </td>
                    <td class="px-6 py-4 text-right font-black">${h.shares.toLocaleString()}</td>
                    <td class="px-6 py-4 text-right text-slate-400 font-bold">${fmt(avgPriceLocal, h.currency)}</td>
                    <td class="px-6 py-4 text-right">
                        <input type="number" step="any" value="${currentPriceLocal.toFixed(3)}" 
                            onchange="window.savePrice('${h.symbol}', this.value)" 
                            class="price-input text-indigo-600 focus:bg-white">
                    </td>
                    <td class="px-6 py-4 text-right font-black">${fmt(marketValHKD)}</td>
                    <td class="px-6 py-4 text-right font-black ${marketValHKD >= h.costHKD ? 'text-emerald-500' : 'text-rose-500'}">
                        ${((marketValHKD - h.costHKD) / h.costHKD * 100).toFixed(2)}%
                    </td>
                </tr>`;
            });

            // Summaries
            document.getElementById('total-val-hkd').innerText = fmt(totalMktHKD);
            document.getElementById('unrealized-gain').innerText = `Unrealized: ${fmt(totalMktHKD - totalCostHKD)}`;
            document.getElementById('total-div-hkd').innerText = fmt(incomeTotalHKD);
            document.getElementById('total-fees-display').innerText = fmt(tradingFeesHKD + totalAdminFeesHKD);
            document.getElementById('grand-total-profit').innerText = fmt((totalMktHKD - totalCostHKD) + totalRealizedHKD + incomeTotalHKD - totalAdminFeesHKD);

            // Exposures
            const pct = (v, t) => t > 0 ? (v/t*100).toFixed(1) : 0;
            document.getElementById('exp-hk-pct').innerText = pct(hkVal, totalMktHKD) + '%';
            document.getElementById('exp-hk-bar').style.width = pct(hkVal, totalMktHKD) + '%';
            document.getElementById('exp-us-pct').innerText = pct(usVal, totalMktHKD) + '%';
            document.getElementById('exp-us-bar').style.width = pct(usVal, totalMktHKD) + '%';
            document.getElementById('exp-stock-pct').innerText = pct(stkVal, totalMktHKD) + '%';
            document.getElementById('exp-stock-bar').style.width = pct(stkVal, totalMktHKD) + '%';
            document.getElementById('exp-bond-pct').innerText = pct(bndVal, totalMktHKD) + '%';
            document.getElementById('exp-bond-bar').style.width = pct(bndVal, totalMktHKD) + '%';

            // Ledger
            const hBody = document.getElementById('history-body');
            hBody.innerHTML = '';
            const allItems = [
                ...transactions.map(t => ({...t, itype:'TRADE'})),
                ...dividends.map(d => ({...d, itype:'INCOME'})),
                ...adminFees.map(f => ({...f, itype:'FEE'}))
            ].sort((a,b) => new Date(b.date) - new Date(a.date));

            allItems.forEach(item => {
                const label = item.itype === 'TRADE' ? item.action : (item.itype === 'INCOME' ? item.type : 'FEE');
                const detail = item.symbol || item.description;
                const qtyVal = item.itype === 'TRADE' ? `${item.shares} @ ${item.price}` : fmt(item.amount, item.currency);
                
                hBody.innerHTML += `<tr class="hover:bg-slate-50">
                    <td class="px-6 py-4 text-slate-400 font-bold">${item.date}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded text-[9px] font-black uppercase ${item.itype==='TRADE' ? (item.action==='BUY'?'bg-blue-50 text-blue-700':'bg-amber-50 text-amber-700') : (item.itype==='INCOME'?'bg-emerald-50 text-emerald-700':'bg-rose-50 text-rose-700')}">${label}</span></td>
                    <td class="px-6 py-4 font-black">${detail}</td>
                    <td class="px-6 py-4 text-right font-bold text-slate-600">${qtyVal}</td>
                    <td class="px-6 py-4 text-center space-x-2">
                         <button onclick="window.editGeneric('${item.itype}', '${item.id}')" class="text-indigo-500 font-black uppercase text-[10px] hover:underline">Edit</button>
                        <button onclick="window.deleteItem('${item.itype}', '${item.id}')" class="text-rose-400 font-black uppercase text-[10px] hover:underline">Del</button>
                    </td>
                </tr>`;
            });
        }

        // --- Database Logic ---
        window.savePrice = async (symbol, price) => {
            if (!user) return toggleSettings();
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'prices', symbol), { price: parseFloat(price) });
        };

        window.deleteItem = async (type, id) => {
            if (!user) return toggleSettings();
            if (!confirm("Delete?")) return;
            const col = type === 'TRADE' ? 'transactions' : (type === 'INCOME' ? 'dividends' : 'fees');
            await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, col, id));
        };

        // --- EDITING LOGIC ---
        window.editGeneric = (type, id) => {
            if(type === 'TRADE') {
                const t = transactions.find(x => x.id === id);
                document.getElementById('edit-id').value = t.id;
                document.getElementById('trade-date').value = t.date;
                document.getElementById('assetType').value = t.assetType;
                document.getElementById('symbol').value = t.symbol;
                document.getElementById('action').value = t.action;
                document.getElementById('shares').value = t.shares;
                document.getElementById('price').value = t.price;
                document.getElementById('currency').value = t.currency;
                document.getElementById('fee').value = t.fee;
                document.getElementById('save-tx-btn').innerText = "Update Transaction";
                document.getElementById('tx-cancel-btn').classList.remove('hidden');
            } else if(type === 'INCOME') {
                const d = dividends.find(x => x.id === id);
                document.getElementById('div-edit-id').value = d.id;
                document.getElementById('div-type').value = d.type;
                document.getElementById('div-symbol').value = d.symbol;
                document.getElementById('div-amount').value = d.amount;
                document.getElementById('div-currency').value = d.currency;
                document.getElementById('div-date').value = d.date;
                document.getElementById('log-income-btn').innerText = "Update Income";
                document.getElementById('div-cancel-btn').classList.remove('hidden');
            } else {
                const f = adminFees.find(x => x.id === id);
                document.getElementById('fee-edit-id').value = f.id;
                document.getElementById('fee-desc').value = f.description;
                document.getElementById('fee-amount').value = f.amount;
                document.getElementById('fee-currency').value = f.currency;
                document.getElementById('fee-date').value = f.date;
                document.getElementById('log-fees-btn').innerText = "Update Fee";
                document.getElementById('fee-cancel-btn').classList.remove('hidden');
            }
            window.scrollTo({top:0, behavior:'smooth'});
        };

        // Cancel Handlers
        const resetTx = () => { document.getElementById('tx-form').reset(); document.getElementById('edit-id').value = ''; document.getElementById('save-tx-btn').innerText = "Save Transaction"; document.getElementById('tx-cancel-btn').classList.add('hidden'); };
        document.getElementById('tx-cancel-btn').onclick = resetTx;
        const resetDiv = () => { document.getElementById('div-form').reset(); document.getElementById('div-edit-id').value = ''; document.getElementById('log-income-btn').innerText = "Log Income"; document.getElementById('div-cancel-btn').classList.add('hidden'); };
        document.getElementById('div-cancel-btn').onclick = resetDiv;
        const resetFee = () => { document.getElementById('fee-form').reset(); document.getElementById('fee-edit-id').value = ''; document.getElementById('log-fees-btn').innerText = "Log Fee"; document.getElementById('fee-cancel-btn').classList.add('hidden'); };
        document.getElementById('fee-cancel-btn').onclick = resetFee;

        // --- SUBMISSION ---
        document.getElementById('tx-form').onsubmit = async (e) => {
            e.preventDefault();
            if(!user) return;
            const id = document.getElementById('edit-id').value || crypto.randomUUID();
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'transactions', id), {
                id, date: document.getElementById('trade-date').value,
                assetType: document.getElementById('assetType').value, symbol: document.getElementById('symbol').value.toUpperCase(),
                action: document.getElementById('action').value, shares: parseFloat(document.getElementById('shares').value),
                price: parseFloat(document.getElementById('price').value), currency: document.getElementById('currency').value,
                fee: parseFloat(document.getElementById('fee').value || 0)
            });
            resetTx();
        };

        document.getElementById('div-form').onsubmit = async (e) => {
            e.preventDefault();
            if(!user) return;
            const id = document.getElementById('div-edit-id').value || crypto.randomUUID();
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'dividends', id), {
                id, type: document.getElementById('div-type').value, symbol: document.getElementById('div-symbol').value.toUpperCase(),
                amount: parseFloat(document.getElementById('div-amount').value), currency: document.getElementById('div-currency').value, 
                date: document.getElementById('div-date').value
            });
            resetDiv();
        };

        document.getElementById('fee-form').onsubmit = async (e) => {
            e.preventDefault();
            if(!user) return;
            const id = document.getElementById('fee-edit-id').value || crypto.randomUUID();
            await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'fees', id), {
                id, description: document.getElementById('fee-desc').value, amount: parseFloat(document.getElementById('fee-amount').value),
                currency: document.getElementById('fee-currency').value, date: document.getElementById('fee-date').value
            });
            resetFee();
        };

        // --- FX & BOOT ---
        const fetchLiveFX = async () => {
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await res.json();
                if (data.rates.HKD) {
                    usdToHkd = data.rates.HKD;
                    document.getElementById('fx-rate-input').value = usdToHkd.toFixed(4);
                    render();
                }
            } catch(e) {}
        };
        document.getElementById('fx-rate-input').onchange = (e) => { usdToHkd = parseFloat(e.target.value); document.getElementById('fx-live-indicator').classList.add('hidden'); render(); };

        async function boot() {
            const configStr = localStorage.getItem('we_fb_config');
            if (!configStr) return toggleSettings();
            try {
                const config = JSON.parse(configStr);
                const app = initializeApp(config);
                auth = getAuth(app);
                db = getFirestore(app);
                
                document.getElementById('google-auth-section').classList.remove('hidden');
                document.getElementById('google-signin-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

                onAuthStateChanged(auth, u => {
                    user = u;
                    const dot = document.getElementById('sync-dot');
                    const text = document.getElementById('sync-text');
                    setButtonState(!!u);
                    
                    if (u) {
                        dot.className = "sync-indicator bg-emerald-500";
                        text.innerText = "Online";
                        const root = ['artifacts', appId, 'users', u.uid];
                        onSnapshot(collection(db, ...root, 'transactions'), s => { transactions = s.docs.map(d => d.data()); render(); });
                        onSnapshot(collection(db, ...root, 'dividends'), s => { dividends = s.docs.map(d => d.data()); render(); });
                        onSnapshot(collection(db, ...root, 'fees'), s => { adminFees = s.docs.map(d => d.data()); render(); });
                        onSnapshot(collection(db, ...root, 'prices'), s => { s.docs.forEach(d => marketPrices[d.id] = d.data().price); render(); });
                        document.getElementById('settings-modal').classList.add('hidden');
                    } else {
                        dot.className = "sync-indicator bg-amber-400";
                        text.innerText = "Sign In";
                    }
                });
                fetchLiveFX();
            } catch (e) { alert("Config Error"); toggleSettings(); }
        }

        boot();
        document.querySelectorAll('input[type="date"]').forEach(i => i.valueAsDate = new Date());
    </script>
</body>
</html>